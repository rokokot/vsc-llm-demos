#!/usr/bin/env python3
import subprocess
import sys
import os

MODEL = "llama3.2:3b"
VSC_LLM_ROOT = os.environ.get('VSC_LLM_ROOT',
f"{os.environ['VSC_SCRATCH']}/vsc-llm")
CONTAINER = f"{VSC_LLM_ROOT}/containers/ollama.sif"

# Pull model if needed
print(f"Checking model {MODEL}...", end='', flush=True)
subprocess.run([
  "apptainer", "exec", "--nv",
  "--bind", "/tmp/ollama_models:/models",
  "--env", "OLLAMA_MODELS=/models",
  CONTAINER, "ollama", "pull", MODEL
], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
print(" âœ“")

# Start chat
print(f"\n{'='*60}\n  VSC-LLM Chat (Llama 3.2-3B)\n  Type /bye to exit\n{'='*60}\n")

proc = subprocess.Popen([
  "apptainer", "exec", "--nv",
  "--bind", "/tmp/ollama_models:/models",
  "--env", "OLLAMA_MODELS=/models",
  CONTAINER, "ollama", "run", MODEL
], stderr=subprocess.DEVNULL)

proc.wait()